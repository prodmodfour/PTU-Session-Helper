<template>
  <div
    class="combatant-card"
    :class="{
      'combatant-card--current': isCurrent,
      'combatant-card--fainted': isFainted,
      'combatant-card--player': combatant.side === 'players',
      'combatant-card--ally': combatant.side === 'allies',
      'combatant-card--enemy': combatant.side === 'enemies'
    }"
  >
    <!-- Sprite/Avatar -->
    <div class="combatant-card__visual">
      <img v-if="isPokemon" :src="spriteUrl" :alt="displayName" class="combatant-card__sprite" />
      <div v-else class="combatant-card__avatar">
        <img v-if="avatarUrl" :src="avatarUrl" :alt="displayName" />
        <span v-else>{{ displayName.charAt(0) }}</span>
      </div>
    </div>

    <!-- Info -->
    <div class="combatant-card__info">
      <div class="combatant-card__header">
        <span class="combatant-card__name">{{ displayName }}</span>
        <span class="combatant-card__level">Lv.{{ entity.level }}</span>
      </div>

      <!-- Types (Pokemon only) -->
      <div v-if="isPokemon" class="combatant-card__types">
        <span
          v-for="type in pokemonTypes"
          :key="type"
          class="type-badge type-badge--sm"
          :class="`type-badge--${type.toLowerCase()}`"
        >
          {{ type }}
        </span>
      </div>

      <!-- Health Bar -->
      <div class="combatant-card__health">
        <HealthBar
          :current-hp="entity.currentHp"
          :max-hp="entity.maxHp"
          :temp-hp="tempHp"
          :show-exact-values="isGm"
        />
      </div>

      <!-- Injuries indicator -->
      <div v-if="injuries > 0" class="combatant-card__injuries">
        <span class="injury-badge" :class="{ 'injury-badge--severe': injuries >= 5 }">
          {{ injuries }} {{ injuries === 1 ? 'Injury' : 'Injuries' }}
        </span>
      </div>

      <!-- Status Conditions -->
      <div v-if="statusConditions.length > 0" class="combatant-card__status">
        <span
          v-for="status in statusConditions"
          :key="status"
          class="status-badge"
          :class="`status-badge--${status.toLowerCase().replace(' ', '-')}`"
        >
          {{ status }}
        </span>
      </div>

      <!-- Combat Stages (GM only, show non-zero) -->
      <div v-if="isGm && hasStageChanges" class="combatant-card__stages">
        <span
          v-for="(value, stat) in nonZeroStages"
          :key="stat"
          class="stage-badge"
          :class="{ 'stage-badge--positive': value > 0, 'stage-badge--negative': value < 0 }"
        >
          {{ formatStatName(stat as string) }} {{ value > 0 ? '+' : '' }}{{ value }}
        </span>
      </div>

      <!-- Initiative (GM only) -->
      <div v-if="isGm" class="combatant-card__initiative">
        Init: {{ combatant.initiative }}
        <span v-if="combatant.initiativeRollOff" class="combatant-card__rolloff">
          ({{ combatant.initiativeRollOff }})
        </span>
      </div>

      <!-- Capture Rate (GM only, wild Pokemon) -->
      <CaptureRateDisplay
        v-if="isGm && isWildPokemon && captureRate"
        :capture-rate="captureRate"
        :show-breakdown="true"
        class="combatant-card__capture-rate"
      />
    </div>

    <!-- GM Actions -->
    <div v-if="isGm" class="combatant-card__actions">
      <!-- HP Controls -->
      <div class="action-row">
        <input
          v-model.number="damageInput"
          type="number"
          class="form-input form-input--sm"
          placeholder="DMG"
          min="0"
        />
        <button class="btn btn--sm btn--danger" @click="applyDamage">
          -HP
        </button>
      </div>
      <div class="action-row">
        <input
          v-model.number="healInput"
          type="number"
          class="form-input form-input--sm"
          placeholder="HEAL"
          min="0"
        />
        <button class="btn btn--sm btn--success" @click="applyHeal">
          +HP
        </button>
      </div>

      <!-- Quick Actions -->
      <div class="action-row action-row--controls">
        <button
          class="btn btn--sm btn--secondary"
          title="Add Temp HP"
          @click="showTempHpModal = true"
        >
          +T
        </button>
        <button
          class="btn btn--sm btn--secondary"
          title="Modify Stages"
          @click="showStagesModal = true"
        >
          CS
        </button>
        <button
          class="btn btn--sm btn--secondary"
          title="Status Conditions"
          @click="showStatusModal = true"
        >
          ST
        </button>
      </div>

      <!-- Actions Button -->
      <button
        class="btn btn--sm btn--primary"
        title="Take Action"
        @click="handleActClick"
      >
        Act
      </button>

      <button class="btn btn--sm btn--ghost" @click="$emit('remove', combatant.id)">
        Remove
      </button>
    </div>

    <!-- Modals -->
    <TempHpModal
      v-if="showTempHpModal"
      :current-temp-hp="tempHp"
      @close="showTempHpModal = false"
      @apply="handleTempHpApply"
    />

    <CombatStagesModal
      v-if="showStagesModal"
      :combatant-name="displayName"
      :current-stages="stages"
      @close="showStagesModal = false"
      @save="handleStagesSave"
    />

    <StatusConditionsModal
      v-if="showStatusModal"
      :combatant-name="displayName"
      :current-statuses="statusConditions"
      @close="showStatusModal = false"
      @save="handleStatusSave"
    />
  </div>
</template>

<script setup lang="ts">
import type { Combatant, Pokemon, HumanCharacter, StatusCondition, StageModifiers } from '~/types'

const props = defineProps<{
  combatant: Combatant
  isCurrent: boolean
  isGm: boolean
}>()

const emit = defineEmits<{
  action: [combatantId: string, action: { type: string; data: unknown }]
  damage: [combatantId: string, damage: number]
  heal: [combatantId: string, amount: number, tempHp?: number, healInjuries?: number]
  remove: [combatantId: string]
  stages: [combatantId: string, changes: Partial<StageModifiers>, absolute: boolean]
  status: [combatantId: string, add: StatusCondition[], remove: StatusCondition[]]
  openActions: [combatantId: string]
}>()

const { getSpriteUrl } = usePokemonSprite()
const { calculateCaptureRateLocal } = useCapture()

// Input states
const damageInput = ref(0)
const healInput = ref(0)

// Modal states
const showTempHpModal = ref(false)
const showStagesModal = ref(false)
const showStatusModal = ref(false)

// Computed properties
const entity = computed(() => props.combatant.entity)
const isPokemon = computed(() => props.combatant.type === 'pokemon')
const avatarUrl = computed(() => isPokemon.value ? '' : (entity.value as HumanCharacter).avatarUrl || '')
const pokemonTypes = computed(() => isPokemon.value ? (entity.value as Pokemon).types : [])

const displayName = computed(() => {
  if (isPokemon.value) {
    const pokemon = entity.value as Pokemon
    return pokemon.nickname || pokemon.species
  }
  return (entity.value as HumanCharacter).name
})

const spriteUrl = computed(() => {
  if (isPokemon.value) {
    const pokemon = entity.value as Pokemon
    return getSpriteUrl(pokemon.species, pokemon.shiny)
  }
  return ''
})

const tempHp = computed(() => entity.value.temporaryHp || 0)
const injuries = computed(() => entity.value.injuries || 0)
const isFainted = computed(() => entity.value.currentHp <= 0)
const statusConditions = computed(() => entity.value.statusConditions || [])

const stages = computed<StageModifiers>(() => entity.value.stageModifiers || {
  attack: 0,
  defense: 0,
  specialAttack: 0,
  specialDefense: 0,
  speed: 0,
  accuracy: 0,
  evasion: 0
})

const nonZeroStages = computed(() => {
  const result: Record<string, number> = {}
  for (const [key, value] of Object.entries(stages.value)) {
    if (value !== 0) {
      result[key] = value as number
    }
  }
  return result
})

const hasStageChanges = computed(() => Object.keys(nonZeroStages.value).length > 0)

// Wild Pokemon check (enemy Pokemon without owner)
const isWildPokemon = computed(() => {
  if (!isPokemon.value) return false
  if (props.combatant.side !== 'enemies') return false
  const pokemon = entity.value as Pokemon
  return !pokemon.ownerId
})

// Capture rate for wild Pokemon
const captureRate = computed(() => {
  if (!isWildPokemon.value) return null
  const pokemon = entity.value as Pokemon
  return calculateCaptureRateLocal({
    level: pokemon.level,
    currentHp: pokemon.currentHp,
    maxHp: pokemon.maxHp,
    evolutionStage: 1,
    maxEvolutionStage: 3,
    statusConditions: pokemon.statusConditions || [],
    injuries: pokemon.injuries || 0,
    isShiny: pokemon.shiny || false
  })
})

// Format stat name for display
// PTU: Evasion bonus is from moves/effects (additive), distinct from stat-derived evasion
const STAT_NAMES: Record<string, string> = {
  attack: 'Atk',
  defense: 'Def',
  specialAttack: 'SpA',
  specialDefense: 'SpD',
  speed: 'Spe',
  accuracy: 'Acc',
  evasion: 'Eva+'
}

const formatStatName = (stat: string): string => STAT_NAMES[stat] || stat

// Actions
const applyDamage = () => {
  if (damageInput.value > 0) {
    emit('damage', props.combatant.id, damageInput.value)
    damageInput.value = 0
  }
}

const applyHeal = () => {
  if (healInput.value > 0) {
    emit('heal', props.combatant.id, healInput.value)
    healInput.value = 0
  }
}

const handleTempHpApply = (amount: number) => {
  emit('heal', props.combatant.id, 0, amount)
}

const handleStagesSave = (changes: Partial<StageModifiers>, absolute: boolean) => {
  emit('stages', props.combatant.id, changes, absolute)
}

const handleStatusSave = (add: StatusCondition[], remove: StatusCondition[]) => {
  if (add.length > 0 || remove.length > 0) {
    emit('status', props.combatant.id, add, remove)
  }
}

const handleActClick = () => {
  emit('openActions', props.combatant.id)
}
</script>

<style lang="scss" scoped>
.combatant-card {
  display: flex;
  gap: $spacing-md;
  padding: $spacing-md;
  background: $glass-bg;
  backdrop-filter: $glass-blur;
  border: 1px solid $glass-border;
  border-radius: $border-radius-lg;
  transition: all $transition-normal;

  // Current turn highlight - color based on side
  &--current.combatant-card--player {
    border-color: $color-side-player;
    background: linear-gradient(135deg, rgba($color-side-player, 0.15) 0%, rgba($color-side-player, 0.05) 100%);
    box-shadow: 0 0 20px rgba($color-side-player, 0.3);
  }

  &--current.combatant-card--ally {
    border-color: $color-side-ally;
    background: linear-gradient(135deg, rgba($color-side-ally, 0.15) 0%, rgba($color-side-ally, 0.05) 100%);
    box-shadow: 0 0 20px rgba($color-side-ally, 0.3);
  }

  &--current.combatant-card--enemy {
    border-color: $color-side-enemy;
    background: linear-gradient(135deg, rgba($color-side-enemy, 0.15) 0%, rgba($color-side-enemy, 0.05) 100%);
    box-shadow: 0 0 20px rgba($color-side-enemy, 0.3);
  }

  &--fainted {
    opacity: 0.5;
    filter: grayscale(30%);
  }

  &__visual {
    width: 64px;
    height: 64px;
    flex-shrink: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    background: linear-gradient(135deg, $color-bg-tertiary 0%, $color-bg-secondary 100%);
    border: 2px solid $border-color-default;
    border-radius: $border-radius-md;
  }

  &__sprite {
    max-width: 100%;
    max-height: 100%;
    image-rendering: pixelated;
  }

  &__avatar {
    width: 100%;
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    overflow: hidden;
    border-radius: $border-radius-md;

    img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    span {
      font-size: $font-size-xl;
      font-weight: 700;
      background: $gradient-sv-cool;
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
  }

  &__info {
    flex: 1;
    min-width: 0;
  }

  &__header {
    display: flex;
    align-items: center;
    gap: $spacing-sm;
    margin-bottom: $spacing-xs;
  }

  &__name {
    font-weight: 600;
    font-size: $font-size-md;
    color: $color-text;
  }

  &__level {
    font-size: $font-size-xs;
    color: $color-text-muted;
  }

  &__types {
    display: flex;
    gap: $spacing-xs;
    margin-bottom: $spacing-xs;

    .type-badge--sm {
      font-size: 0.65rem;
      padding: 1px 4px;
    }
  }

  &__health {
    margin-bottom: $spacing-xs;
    width: 100%;
  }

  &__injuries {
    margin-bottom: $spacing-xs;
  }

  &__status {
    display: flex;
    flex-wrap: wrap;
    gap: $spacing-xs;
    margin-bottom: $spacing-xs;
  }

  &__stages {
    display: flex;
    flex-wrap: wrap;
    gap: $spacing-xs;
    margin-bottom: $spacing-xs;
  }

  &__initiative {
    font-size: $font-size-xs;
    color: $color-accent-scarlet;
    font-weight: 500;
  }

  &__rolloff {
    color: $color-accent-violet;
    font-weight: normal;
    margin-left: 2px;
  }

  &__capture-rate {
    margin-top: $spacing-sm;
  }

  &__actions {
    display: flex;
    flex-direction: column;
    gap: $spacing-xs;
    min-width: 100px;
  }
}

// Injury badge
.injury-badge {
  display: inline-block;
  padding: 2px $spacing-xs;
  font-size: $font-size-xs;
  font-weight: 600;
  color: $color-danger;
  background: rgba($color-danger, 0.2);
  border: 1px solid rgba($color-danger, 0.4);
  border-radius: $border-radius-sm;

  &--severe {
    background: rgba($color-danger, 0.4);
    animation: pulse 1.5s infinite;
  }
}

// Stage badge
.stage-badge {
  display: inline-block;
  padding: 1px $spacing-xs;
  font-size: 0.65rem;
  font-weight: 600;
  border-radius: $border-radius-sm;

  &--positive {
    color: $color-success;
    background: rgba($color-success, 0.2);
  }

  &--negative {
    color: $color-danger;
    background: rgba($color-danger, 0.2);
  }
}

// Action rows
.action-row {
  display: flex;
  gap: $spacing-xs;

  &--controls {
    justify-content: space-between;
  }

  .form-input--sm {
    width: 50px;
    padding: $spacing-xs;
    font-size: $font-size-xs;
    background: $color-bg-tertiary;
    border: 1px solid $border-color-default;
    border-radius: $border-radius-sm;
    color: $color-text;

    &::placeholder {
      color: $color-text-muted;
    }

    &:focus {
      border-color: $color-accent-scarlet;
      outline: none;
      box-shadow: 0 0 0 2px rgba($color-accent-scarlet, 0.2);
    }
  }
}

@keyframes pulse {
  0%, 100% {
    opacity: 1;
  }
  50% {
    opacity: 0.6;
  }
}
</style>
