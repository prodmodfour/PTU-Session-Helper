---
ticket_id: bug-023
priority: P2
severity: MEDIUM
status: resolved
domain: combat
matrix_source:
  rule_id: combat-R012
  audit_file: matrix/combat-audit.md
  ruling: rules-review-047
created_at: 2026-02-19
created_by: orchestrator
---

## Summary

Accuracy check auto-selects damage-class-matching evasion (Physical attack → Physical Evasion, Special attack → Special Evasion) but ignores Speed Evasion entirely. PTU allows the defender to use Speed Evasion against any attack with an accuracy check.

## Expected Behavior (PTU Rules)

Per PTU Core p.234: "Speed Evasion may be applied to any Move with an accuracy check, but you may only add one of your three evasions to any one check." The defender should use whichever evasion is highest — the damage-class-matching one or Speed Evasion.

## Recommended Fix

Per Game Logic Reviewer ruling (rules-review-047): use `Math.max(matchingEvasion, speedEvasion)` to auto-select the best available evasion for the defender.

## Affected Files

- Accuracy check logic (wherever evasion is selected for the threshold calculation)

## PTU Reference

- Core p.234 — Evasion Rules, Speed Evasion

## Fix Log

**Date:** 2026-02-19
**Fixed by:** developer

### Changes Made

1. **`app/composables/useMoveCalculation.ts`** — `getTargetEvasion()` now computes Speed Evasion from the target's speed stat and combat stages, then returns `Math.max(matchingEvasion, speedEvasion)` instead of only the damage-class-matching evasion. Added `calculateSpeedEvasion` from `useCombat()` and `getPokemonSpeedStat` from `useEntityStats()`.

2. **`app/server/api/encounters/[id]/calculate-damage.post.ts`** — Server-side accuracy calculation now uses `Math.max(matchingEvasion, speedEvasion)` for `applicableEvasion` instead of selecting only Physical or Special evasion based on damage class. The `speedEvasion` was already computed but not used in the selection.

3. **`app/utils/damageCalculation.ts`** — Updated `AccuracyCalcResult.applicableEvasion` docstring to reflect the new behavior: "Best evasion for the defender: max(damage-class-matching evasion, Speed Evasion) per PTU p.234".

### Verification

- Both client-side (composable) and server-side (API endpoint) code paths now consider Speed Evasion
- Combat stage modifiers are correctly applied to Speed stat before evasion calculation (via `calculateSpeedEvasion` which calls `calculateEvasion` with `stages.speed`)
- Evasion bonus from moves/effects is applied to Speed Evasion the same way as Physical/Special evasion
- No other evasion selection code paths found in codebase (duplicate check passed)

**Date:** 2026-02-20
**Commit:** `ffdf19a` — `fix: add per-target evasion type label reflecting Speed Evasion selection`

### Changes (code-review-064 feedback)

1. **`app/composables/useMoveCalculation.ts`** — Added `getTargetEvasionLabel(targetId)` function that computes which evasion type (Phys, Spec, or Speed) won the `Math.max` selection for a given target, returning the appropriate label. Removed the old `evasionTypeLabel` computed which was a single value that did not account for Speed Evasion winning.

2. **`app/components/encounter/MoveTargetModal.vue`** — Replaced `evasionTypeLabel` with `getTargetEvasionLabel(target.id)` in the evasion preview, so the label now correctly reflects per-target evasion type selection.
