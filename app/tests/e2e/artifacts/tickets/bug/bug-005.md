---
ticket_id: bug-005
type: bug
priority: P1
severity: HIGH
status: in-progress
source_ecosystem: test
target_ecosystem: dev
created_by: feature-designer
created_at: 2026-02-19T23:50:00Z
domain: pokemon-lifecycle
affected_files:
  - app/server/services/pokemon-generator.service.ts
  - app/prisma/seed.ts
scenario_ids:
  - pokemon-lifecycle-ability-assignment-001
  - pokemon-lifecycle-workflow-wild-spawn-001
---

## Summary

`pickRandomAbility()` picks from the first 2 entries in the stored ability list regardless of whether they are Basic or Advanced abilities. For species with only 1 Basic Ability, the second candidate is the first Advanced Ability, violating PTU rules.

## PTU Rule Reference

PTU 1.05, Chapter 5, page 200:
> "All Pokemon are born with a single Ability, chosen from their Basic Abilities."

Advanced Abilities are only available at Level 20+:
> "At Level 20, a Pokemon gains a Second Ability, which may be chosen from its Basic or Advanced Abilities."

## Evidence

**Generator code** (`pokemon-generator.service.ts:415-419`):
```typescript
function pickRandomAbility(abilityNames: string[]): Array<{ name: string; effect: string }> {
  if (abilityNames.length === 0) return []
  const selected = abilityNames[Math.floor(Math.random() * Math.min(2, abilityNames.length))]
  return [{ name: selected, effect: '' }]
}
```

**Seed stores abilities in order** (`seed.ts:293-296`):
```typescript
const abilityPatterns = [
  /Basic Ability \d:\s*([^\n]+)/gi,   // parsed first
  /Adv Ability \d:\s*([^\n]+)/gi,     // parsed second
  /High Ability:\s*([^\n]+)/gi        // parsed third
]
```

**Example -- Caterpie** (1 Basic Ability):
- Stored array: `["Shield Dust", "Run Away", "Silk Threads", "Stench", "Suction Cups"]`
- `Math.min(2, 5) = 2` → picks from index 0 (Shield Dust, basic) or index 1 (Run Away, **advanced**)
- 50% chance of assigning an Advanced Ability to a newly spawned wild Caterpie

**Example -- Zubat** (2 Basic Abilities):
- Stored array: `["Inner Focus", "Infiltrator", "Insomnia", "Vanguard", "Ambush"]`
- `Math.min(2, 5) = 2` → picks from index 0 (Inner Focus, basic) or index 1 (Infiltrator, basic)
- Correct by coincidence -- both first 2 happen to be basic

## Root Cause

The SpeciesData model stores all abilities in a flat JSON array with no metadata distinguishing basic from advanced. The seed parses Basic Abilities first (so they come first in the array), but the count of basic abilities per species is not stored anywhere. `pickRandomAbility()` assumes the first 2 are always basic, which is only true for species with 2+ Basic Abilities.

## Fix Options

**Option A (data model fix):** Add a `numBasicAbilities` integer field to SpeciesData. The seed already knows the count (it parses basic abilities with a separate regex). `pickRandomAbility()` would use `Math.min(numBasicAbilities, abilityNames.length)` instead of hardcoded 2.

**Option B (seed restructure):** Store abilities as a JSON object with keys `{ basic: [...], advanced: [...], high: [...] }` instead of a flat array. More expressive but requires updating all ability consumers.

**Option A is simpler** and requires fewer changes: one new field in schema, one line in seed, one line in generator.

## Fix Log

Implemented **Option A** (data model fix):

1. **Schema** (`app/prisma/schema.prisma`): Added `numBasicAbilities Int @default(2)` to SpeciesData model
2. **Seed** (`app/prisma/seed.ts`): Parse basic abilities separately and count them; store count in `numBasicAbilities` field
3. **Generator** (`app/server/services/pokemon-generator.service.ts`): `pickRandomAbility()` now accepts `numBasicAbilities` param and limits selection pool to `Math.min(numBasicAbilities, abilityNames.length)` — falls back to full list if `numBasicAbilities` is 0
4. **DB push**: Schema change applied via `prisma db push` (existing records get default value of 2)

Note: Existing DB records get `numBasicAbilities = 2` (the default), which is correct for the majority of species. A re-seed is needed to populate accurate counts for species with 1 or 3+ basic abilities.
