---
ticket_id: bug-024
priority: P2
severity: MEDIUM
status: resolved
domain: character-lifecycle
matrix_source:
  rule_id: character-lifecycle-R008
  audit_file: matrix/character-lifecycle-audit.md
  related_ticket: bug-010
created_at: 2026-02-19
created_by: orchestrator
---

## Summary

Encounter template loading uses `10 + level * 2` for inline human combatant maxHp, missing the HP stat factor. Should use the full trainer HP formula: `level * 2 + hpStat * 3 + 10`.

## Expected Behavior

Inline human combatants loaded from encounter templates should use the correct trainer HP formula.

## Actual Behavior

`encounter-templates/[id]/load.post.ts` line 85 computes `10 + level * 2`, omitting `hpStat * 3`. A level 5 trainer with HP stat 10 gets maxHp = 20 instead of 50.

## Affected Files

- `app/server/api/encounter-templates/[id]/load.post.ts` — line 85

## PTU Reference

- Core Chapter 1 — Trainer Hit Points: `level * 2 + HP_stat * 3 + 10`

## Found During

Developer fix for bug-010 — duplicate code path check identified this secondary location.

## Resolution Log

- **Commit:** `98287f5`
- **Date:** 2026-02-19
- **Files changed:**
  - `app/server/api/encounter-templates/[id]/load.post.ts` — extracted `hpStat` from `tc.entityData?.stats?.hp` (defaulting to 0), changed formula from `10 + level * 2` to `(level * 2) + (hpStat * 3) + 10`
  - `app/server/api/encounter-templates/from-encounter.post.ts` — added `stats` to the persisted human combatant `entityData` so the HP stat is available when loading templates
- **Duplicate code path check:** Searched entire `app/` for patterns `10 + level * 2`, `level * 2` without `hpStat`, and all `maxHp` computations. Confirmed no other locations use the incorrect formula. All trainer HP paths (`useCombat.ts:43`, `characters/index.post.ts:13`, and now this file) use the correct `(level * 2) + (hpStat * 3) + 10`.
