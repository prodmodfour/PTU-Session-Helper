---
ticket_id: bug-018
priority: P2
severity: MEDIUM
status: in-progress
domain: scenes
matrix_source:
  rule_id: scenes-R019
  audit_file: matrix/scenes-audit.md
created_at: 2026-02-19
created_by: orchestrator
---

## Summary

Blocking terrain prevents movement but does NOT block targeting or line-of-sight for attacks passing through it. Ranged attacks can target through walls/obstacles.

## Expected Behavior (PTU Rules)

Per PTU Core: Blocking terrain blocks both movement AND line of sight. Attacks cannot be made through Blocking terrain unless the attacker has a specific ability that allows it.

## Actual Behavior

Blocking terrain only affects movement pathfinding. The accuracy check and targeting system do not consider whether Blocking terrain exists between attacker and target.

## Affected Files

- `app/composables/useGridInteraction.ts` — targeting logic
- `app/composables/useCanvasRendering.ts` — line-of-sight calculations (if any)

## PTU Reference

- Core Chapter 7 — Blocking Terrain, Line of Sight (p.487: "Terrain that cannot be Shifted or Targeted through")

## Fix Log

### 2026-02-20 — Line-of-sight check added to range parser

**Root Cause:** `isInRange()` in `useRangeParser.ts` only checked Chebyshev distance without any LoS validation. No code path existed to check for blocking terrain between attacker and target.

**Fix Applied:**
1. Added `hasLineOfSight()` function to `useRangeParser.ts` — uses Bresenham's line algorithm to trace cells between attacker and target, returning `false` if any intermediate cell is blocking terrain.
2. Extended `isInRange()` signature with optional `isBlockingFn: (x: number, y: number) => boolean` parameter. When provided, LoS is checked after range validation passes.
3. Origin and destination cells are excluded from the blocking check (attacker on blocking terrain can still act; target on blocking terrain can still be targeted if no wall between them).
4. Backward compatible — existing callers without `isBlockingFn` are unaffected.

**Files Changed:**
- `app/composables/useRangeParser.ts` — added `hasLineOfSight()`, extended `isInRange()` signature

**Remaining Work:**
- Wire `isBlockingFn` from terrain store into callers of `isInRange()` (MoveTargetModal target filtering, measurement tools, etc.)
- Unit tests for `hasLineOfSight` directly
