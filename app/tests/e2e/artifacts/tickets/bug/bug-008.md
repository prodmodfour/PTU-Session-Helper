---
ticket_id: bug-008
priority: P1
severity: HIGH
status: resolved
domain: combat
matrix_source:
  rule_id: combat-R103
  audit_file: matrix/combat-audit.md
created_at: 2026-02-19
created_by: orchestrator
---

## Summary

Temporary Hit Points stack additively instead of using `max(old, new)` as PTU requires. Applying multiple sources of Temp HP inflates the buffer beyond intended limits.

## Expected Behavior (PTU Rules)

Per PTU Core: when a character gains Temporary Hit Points while already having some, they keep whichever value is higher — old or new. They do NOT add together.

## Actual Behavior

The app adds new Temp HP on top of existing Temp HP. Two 10-Temp-HP buffs result in 20 Temp HP instead of capping at 10.

## Affected Files

- `app/server/api/` — healing/damage endpoints that set `temporaryHp`
- `app/composables/` — any client-side temp HP logic

## PTU Reference

- Core Chapter 9 — Temporary Hit Points

## Resolution Log

- **Commit:** `f1ba7c3` — fix: use max(old, new) for temporary HP per PTU rules
- **File changed:** `app/server/services/combatant.service.ts`
- **Fix:** Changed `applyHealingToEntity()` from additive temp HP stacking (`previousTempHp + options.tempHp`) to `Math.max(previousTempHp, options.tempHp)` per PTU rules. Also corrected `tempHpGained` to report the actual delta.
- **Duplicate path check:** All 4 code paths that set `temporaryHp` were audited — damage absorption (correct), breather reset to 0 (correct), entity-update passthrough (correct), and the healing grant (fixed).
