---
ticket_id: bug-015
priority: P2
severity: MEDIUM
status: in-progress
domain: character-lifecycle
matrix_source:
  rule_ids:
    - character-lifecycle-R033
    - character-lifecycle-R037
    - character-lifecycle-R055
  audit_file: matrix/character-lifecycle-audit.md
created_at: 2026-02-19
created_by: orchestrator
---

## Summary

Features and Edges cannot be updated via the character PUT endpoint. These fields are frozen after creation or CSV import. This prevents duplicate feature prevention (R037) and makes retraining impossible (R055).

## Expected Behavior (PTU Rules)

Trainers should be able to gain new Features and Edges as they level up, and retrain existing ones per PTU retraining rules. The app should allow editing these fields.

## Actual Behavior

The PUT endpoint for characters does not handle `features` or `edges` fields. Once set during creation or CSV import, they cannot be modified through the API. Three audit findings trace to this root cause:
- R033: Features/edges not updatable via PUT
- R037: No duplicate feature prevention (can't edit to check)
- R055: Retraining impossible (can't swap features/edges)

## Affected Files

- `app/server/api/characters/[id].put.ts` — missing features/edges in update body handling

## PTU Reference

- Core Chapter 1 — Features and Edges, Retraining

## Fix Log

**2026-02-19** — Added `features` and `edges` handling to `app/server/api/characters/[id].put.ts`.

**Root cause:** The character PUT endpoint mapped JSON-stringified fields for `trainerClasses`, `skills`, `inventory`, `statusConditions`, and `stageModifiers`, but `features` and `edges` were omitted. Both fields existed in the Prisma schema (as JSON string columns with `@default("[]")`) and were correctly handled in the POST (create) endpoint and the serializer, but the PUT endpoint simply never included them.

**Fix:** Added two lines to the PUT endpoint's update-data builder, following the identical pattern used by the other JSON array fields:
```
if (body.features !== undefined) updateData.features = JSON.stringify(body.features)
if (body.edges !== undefined) updateData.edges = JSON.stringify(body.edges)
```

**Duplicate code path check:** Searched all `prisma.humanCharacter.update` call sites (8 total). The other 7 are specialized endpoints (rest, extended-rest, new-day, heal-injury, pokemon-center, entity-update service) that only touch combat/healing state. None need features/edges handling.

**Pokemon equivalent check:** The Pokemon model does not have `features` or `edges` fields. Pokemon have `abilities` and `moves` instead, both of which are already handled in the Pokemon PUT endpoint. No equivalent fix needed.

**Commit:** `fix: add features/edges handling to character PUT endpoint`
