---
ticket_id: bug-019
priority: P2
severity: MEDIUM
status: in-progress
domain: vtt-grid
matrix_source:
  rule_id: vtt-grid-R006
  audit_file: matrix/vtt-grid-audit.md
created_at: 2026-02-19
created_by: orchestrator
---

## Summary

Adjacency and range checks use a single origin point. Multi-cell tokens (Large, Huge, Gigantic size categories) are not accounted for — range is measured from one corner rather than the nearest occupied cell.

## Expected Behavior (PTU Rules)

Per PTU Core: range for multi-cell tokens should be measured from the nearest occupied cell of the token to the nearest cell of the target. A 2x2 Large token attacking an adjacent target should measure from the closest cell, not from a fixed origin.

## Actual Behavior

All range calculations use the token's single position coordinate. A 2x2 token positioned at (5,5) measures range from (5,5) only, not from (5,6), (6,5), or (6,6).

## Affected Files

- `app/composables/useGridMovement.ts` — range/adjacency calculations
- `app/composables/useGridInteraction.ts` — targeting

## PTU Reference

- Core Chapter 7 — Token Sizes (p.402: "Large is 2x2, Huge is 3x3, and Gigantic is 4x4"), Range Measurement

## Fix Log

### 2026-02-20 — Multi-cell range measurement added to range parser

**Root Cause:** `isInRange()` in `useRangeParser.ts` used single-point Chebyshev distance: `Math.max(Math.abs(target.x - attacker.x), Math.abs(target.y - attacker.y))`. This only considers the top-left corner cell of multi-cell tokens, ignoring all other occupied cells.

**Fix Applied:**
1. Added `TokenFootprint` interface (`{ position: GridPosition, size: number }`) to represent multi-cell tokens.
2. Added `getOccupiedCells(token)` — returns all cells a token occupies (e.g., 4 cells for a 2x2 Large token).
3. Added `chebyshevDistanceTokens(a, b)` — O(1) rectangle-to-rectangle Chebyshev distance using interval gap calculation, avoiding O(n*m) cell-pair iteration.
4. Added `closestCellPair(a, b)` — finds the nearest cell pair between two tokens (used for LoS tracing).
5. Extended `isInRange()` with optional `attackerSize` and `targetSize` parameters (default 1). All distance/adjacency checks now use `chebyshevDistanceTokens()` instead of raw point distance.
6. Updated self-targeting and cardinally-adjacent logic for multi-cell tokens.

**Files Changed:**
- `app/composables/useRangeParser.ts` — added `TokenFootprint`, `getOccupiedCells`, `chebyshevDistanceTokens`, `closestCellPair`, extended `isInRange` signature

### 2026-02-20 — Token size wired into move targeting flow (ef080be)

**Integration Applied:**
1. `useMoveCalculation.ts` now passes `Combatant.tokenSize` (defaulting to 1) as `attackerSize` and `targetSize` to `isInRange()`
2. Both the primary range check and the LoS-only fallback check use token sizes
3. The `Combatant` type already has `tokenSize: number` (1=1x1, 2=2x2 Large, 3=3x3 Huge, 4=4x4 Gigantic)
4. VTT grid token data (`TokenData` in `useGridInteraction.ts`) already tracks `size` from combatant data

**Files Changed:**
- `app/composables/useMoveCalculation.ts` — pass tokenSize as attackerSize/targetSize

**Remaining Work:**
- Update `calculateMoveDistance` in movement code if movement distance for multi-cell tokens needs similar treatment (currently movement uses origin point which may be correct for movement origin)
- Unit tests for multi-cell distance calculations
