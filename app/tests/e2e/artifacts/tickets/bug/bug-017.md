---
ticket_id: bug-017
priority: P2
severity: MEDIUM
status: resolved
domain: scenes
matrix_source:
  rule_id: scenes-R016
  audit_file: matrix/scenes-audit.md
created_at: 2026-02-19
created_by: orchestrator
---

## Summary

VTT terrain types do not match PTU terrain definitions. Earth terrain (requires Burrow capability to traverse) and Rough terrain (-2 accuracy penalty) are missing. Hazard and Elevated are app-specific additions not in PTU.

## Expected Behavior (PTU Rules)

Per PTU Core terrain types: Normal, Slow (2x movement cost), Blocking (impassable without flight/phase), Rough (-2 accuracy), Earth (requires Burrow). The VTT should support all PTU terrain types.

## Actual Behavior

The terrain painter supports: Normal, Slow, Blocking, Water, Hazard, Elevated. Missing: Earth, Rough. Present but non-PTU: Hazard, Elevated.

## Affected Files

- `app/types/terrain.ts` or terrain type definitions
- `app/composables/useTerrainPersistence.ts`
- Terrain painter UI components

## PTU Reference

- Core Chapter 8 — Terrain Types

## Fix Log

**Date:** 2026-02-20
**Commit:** f2fe6a1

### Changes Made

1. **`app/types/spatial.ts`** — Added `'earth'` and `'rough'` to the `TerrainType` union type with PTU-accurate comments.

2. **`app/stores/terrain.ts`** — Added Earth and Rough to `TERRAIN_COSTS` (earth=Infinity base, rough=1), `TERRAIN_COLORS` (earth=dark brown, rough=dark khaki). Updated `getMovementCost` getter to accept `canBurrow` parameter and return 1 for earth when burrow available, Infinity otherwise. Updated `isPassable` getter to accept `canBurrow` parameter and reject earth terrain without burrow.

3. **`app/composables/useCanvasDrawing.ts`** — Added canvas drawing patterns: downward arrow for earth terrain, jagged line for rough terrain.

4. **`app/composables/useCanvasRendering.ts`** — Added identical canvas drawing patterns for earth and rough terrain (this composable has a parallel implementation of `drawTerrainPattern`).

5. **`app/components/vtt/TerrainPainter.vue`** — Added Earth and Rough terrain buttons with icons, labels, descriptions, and cost labels. Renamed "Difficult" label to "Slow" to match PTU terminology. Updated grid layout from 3 to 4 columns to fit 8 terrain types.

6. **`app/tests/unit/stores/terrain.test.ts`** — Added earth and rough to cost/color assertions. Added movement cost tests for earth (with/without burrow) and rough. Added passability tests for earth (with/without burrow) and rough.

### PTU Rules Applied

- **Earth Terrain** (PTU Core Ch. 7): Underground terrain requiring Burrow capability. Impassable without it, normal movement cost with it.
- **Rough Terrain** (PTU Core Ch. 7): -2 accuracy penalty when targeting through. Normal movement cost (note: most rough terrain is also slow per PTU, but that stacking is a GM decision per encounter setup).

### Duplicate Code Path Check

Searched all `.ts` files for hardcoded terrain type lists. Found terrain types referenced in:
- `app/types/spatial.ts` — type union (updated)
- `app/stores/terrain.ts` — costs, colors, movement logic (updated)
- `app/composables/useCanvasDrawing.ts` — switch cases (updated)
- `app/composables/useCanvasRendering.ts` — switch cases (updated)
- `app/components/vtt/TerrainPainter.vue` — UI terrain list (updated)
- `app/tests/unit/stores/terrain.test.ts` — test terrain list (updated)
- `app/composables/useGridRendering.ts` — uses `TERRAIN_COLORS[terrain]` dynamically (no change needed)
- `app/composables/useGridMovement.ts` — uses store getters (no change needed)
- `app/server/api/encounters/[id]/terrain.put.ts` — uses TerrainType generically (no change needed)
- `app/composables/useTerrainPersistence.ts` — uses TerrainType generically (no change needed)
