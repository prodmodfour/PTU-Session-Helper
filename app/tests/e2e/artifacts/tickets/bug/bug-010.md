---
ticket_id: bug-010
priority: P1
severity: HIGH
status: resolved
domain: character-lifecycle
matrix_source:
  rule_id: character-lifecycle-R008
  audit_file: matrix/character-lifecycle-audit.md
created_at: 2026-02-19
created_by: orchestrator
---

## Summary

Trainer HP formula is never computed during manual character creation. The `maxHp` field is set to the raw HP stat value (typically 10) instead of the PTU formula `level * 2 + HP_stat * 3 + 10`.

## Expected Behavior (PTU Rules)

Per PTU Core: Trainer Max HP = Level * 2 + HP Stat * 3 + 10. A level 1 trainer with 10 HP stat should have maxHp = 1*2 + 10*3 + 10 = 42.

## Actual Behavior

Manual creation sets maxHp to the raw HP stat value (e.g., 10). CSV import may compute it correctly, but manual creation bypasses the formula entirely. This makes manually created trainers extremely fragile.

## Affected Files

- `app/server/api/characters/index.post.ts` — character creation endpoint
- Any client-side character creation logic

## PTU Reference

- Core Chapter 1 — Trainer Hit Points

## Resolution Log

- **Commit:** `566f1a1` — fix: compute trainer HP formula on manual character creation
- **File changed:** `app/server/api/characters/index.post.ts`
- **Fix:** Extracted `level` and `hpStat` from the request body, computed `computedMaxHp = level * 2 + hpStat * 3 + 10`, and used it as the default when `body.maxHp` is not provided. A level 1 trainer with HP stat 10 now correctly gets maxHp = 42.
- **Other creation paths checked:**
  - CSV import (`csv-import.service.ts`): reads maxHp from spreadsheet cell, falls back to `level + stats.hp * 3 + 10` (Pokemon formula, not trainer — but for CSV the spreadsheet value is authoritative)
  - Pokemon manual creation (`/api/pokemon/index.post.ts`): already uses Pokemon HP formula correctly
  - Pokemon generator service: already uses Pokemon HP formula correctly
- **Known related issue:** `encounter-templates/[id]/load.post.ts` line 85 uses `10 + level * 2` for inline human combatants (missing HP stat factor) — separate ticket scope.
