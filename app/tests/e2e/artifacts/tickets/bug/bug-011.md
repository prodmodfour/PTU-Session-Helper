---
ticket_id: bug-011
priority: P1
severity: HIGH
status: in-progress
domain: encounter-tables
matrix_source:
  rule_id: encounter-tables-R007
  audit_file: matrix/encounter-tables-audit.md
created_at: 2026-02-19
created_by: orchestrator
---

## Summary

The `weight` column in `EncounterTableEntry` uses Prisma `Int` type. Fractional weights (e.g., 0.1 for legendary-tier species) are truncated to 0, making those entries unreachable during random generation.

## Expected Behavior (PTU Rules)

Encounter tables should support fractional weights so rare/legendary Pokemon can have sub-1 weight values while still being eligible for random selection.

## Actual Behavior

Any weight < 1 is truncated to 0 by the Int column. Entries with weight 0 are never selected by the weighted random algorithm. Legendary-tier entries configured with fractional weights silently become impossible to encounter.

## Affected Files

- `app/prisma/schema.prisma` — `EncounterTableEntry.weight` column type
- `app/server/api/encounter-tables/` — entry creation/update endpoints
- Generation algorithm that reads weights

## Fix Direction

Change `weight` from `Int` to `Float` in Prisma schema, run migration. Validate that existing integer weights still work correctly with the float type.

## PTU Reference

- Core Chapter 11 — Running the Game, Encounter Tables

## Resolution Log

- **Commit:** `d6e6ad7` — fix: change encounter table weight columns from Int to Float
- **Files changed:**
  - `app/prisma/schema.prisma` — Changed `EncounterTableEntry.weight` from `Int @default(10)` to `Float @default(10)` and `ModificationEntry.weight` from `Int?` to `Float?`
  - `app/components/habitat/EncounterTableModal.vue` — Updated inline weight input to accept fractional values (`min="0.1"`, `step="0.1"`), added Legendary (0.1) option to weight preset dropdown
- **Schema migration:** `npx prisma db push --accept-data-loss` (Int to Float cast preserves all existing integer values)
- **Duplicate code path check:** Searched all server endpoints, stores, composables, and components for `parseInt` or integer coercion on weight values. No other code paths truncate weight to integer. The `EntryRow.vue` component already used `parseFloat` and `min="0.1"` / `step="0.1"`. The `ModificationCard.vue` component already had `min="0.1"` / `step="0.1"`. The `[entryId].put.ts` validation already checked `weight >= 0.1`. The weighted random selection algorithm in `generate.post.ts` uses standard float arithmetic.
- **Types verified:** `app/types/habitat.ts` already declares `weight: number` (TypeScript number handles both int and float), and `RARITY_WEIGHTS` already includes `legendary: 0.1`.
