---
ticket_id: bug-026
priority: P2
severity: MEDIUM
status: resolved
domain: combat
matrix_source:
  related_tickets: [bug-024]
  discovered_by: code-review-059
created_at: 2026-02-19
created_by: orchestrator
---

## Summary

Encounter template load endpoint uses incorrect field names and data shapes for human combatants, causing type mismatches with the `Combatant` and `HumanCharacter` types used by downstream consumers.

## Issues (3)

### 1. `injuries` field uses wrong shape

Template load creates `injuries: { count: 0, max: 10 }` but:
- `Combatant` type expects `InjuryState` with `{ count, sources }` shape
- `HumanCharacter` entity uses a plain `number` for injuries

### 2. `combatStages` instead of `stageModifiers`

Template load uses field name `combatStages` but the `Combatant` type uses `stageModifiers`.

### 3. `tempHp` instead of `temporaryHp`

Template load uses field name `tempHp` but `HumanCharacter` type uses `temporaryHp`.

## Affected Files

- `app/server/api/encounter-templates/[id]/load.post.ts` — inline human combatant construction

## Fix Direction

Align the field names and shapes with the actual `Combatant` and `HumanCharacter` types. Check all field names in the template load human combatant object against the type definitions.

## Fix Log

**Date:** 2026-02-19
**Commit:** `70ee060` — `fix: align template load human combatant fields with type definitions`
**File:** `app/server/api/encounter-templates/[id]/load.post.ts`

### Changes

**Issue 1 — injuries field shape:**
- Entity level (HumanCharacter): changed `injuries: { count: 0, max: 5 }` to `injuries: 0` (plain number per `HumanCharacter` type)
- Combatant level: changed `injuries: { count: 0, max: 5 }` to `injuries: { count: 0, sources: [] }` (matches `InjuryState` type)

**Issue 2 — combatStages vs stageModifiers:**
- Removed `combatStages` from combatant level (field does not exist on `Combatant` type)
- Added `stageModifiers` to entity level (correct location per `HumanCharacter` type, matching `StageModifiers` interface)

**Issue 3 — tempHp vs temporaryHp:**
- Renamed `tempHp: 0` to `temporaryHp: 0` on entity (matches `HumanCharacter.temporaryHp` field)

**Bonus fixes (alignment with canonical `buildCombatantFromEntity`):**
- Added missing `actionsRemaining: 2` and `shiftActionsRemaining: 1` on combatant
- Added missing `canBeCommanded: true` and `isHolding: false` on `turnState`

### Duplicate code path check
Searched entire `app/` tree for `combatStages`, `tempHp: 0`, and `injuries.*count.*max` patterns. Only instance was in this file. The canonical combatant builder (`combatant.service.ts:buildCombatantFromEntity`) already uses correct shapes. Pokemon combatants in this same endpoint already delegate to `buildPokemonCombatant` which calls the canonical builder.

**Date:** 2026-02-20
**Commit:** `9f36bfa` — `fix: move statusConditions to entity level and add entityId for template human combatants`
**File:** `app/server/api/encounter-templates/[id]/load.post.ts`

### Changes (code-review-065 feedback)

**Issue 4 — statusConditions on wrong level:**
- Moved `statusConditions: []` from the combatant level into the entity object (after `stageModifiers`), matching the canonical `HumanCharacter` type which has `statusConditions` on the entity, not the combatant.

**Issue 5 — missing entityId:**
- Extracted entity `id` generation into a `const entityId = uuidv4()` variable, used for both `entity.id` and `entityId` on the combatant wrapper. The `Combatant` type requires `entityId: string` (non-optional).

### Duplicate code path check
Searched `app/server/` for `statusConditions: []` patterns. Only two locations found: `pokemon-generator.service.ts` (correctly on entity level) and this file (now fixed to entity level). No other combatant construction paths with misplaced statusConditions.
