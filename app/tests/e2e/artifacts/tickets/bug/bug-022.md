---
ticket_id: bug-022
priority: P3
severity: LOW
status: in-progress
domain: character-lifecycle
matrix_source:
  rule_id: character-lifecycle-R042
  audit_file: matrix/character-lifecycle-audit.md
created_at: 2026-02-19
created_by: orchestrator
---

## Summary

No scene-end AP restoration mechanism exists. Only drainedAp tracking and Extended Rest AP restore are implemented. AP is not automatically replenished when a scene ends.

## Expected Behavior (PTU Rules)

Per PTU Core: Action Points are completely regained at the end of each scene. Only AP lost to Drain effects remain unavailable until restored by Extended Rest.

## Actual Behavior

There is no scene-end trigger that restores AP. The app tracks `drainedAp` but has no concept of current AP pool, total AP, or scene-boundary restoration.

## Affected Files

- Scene deactivation endpoints
- Character/Pokemon AP tracking (currently only `drainedAp` field exists)

## PTU Reference

- Core Chapter 8 — Action Points, Scene Boundaries

## Fix Log

**2026-02-20** — Implemented full scene-end AP restoration mechanism:

1. Added `currentAp` field to HumanCharacter in Prisma schema (default 5).
2. Added `calculateMaxAp(level)` and `calculateSceneEndAp(level, drainedAp)` utilities in `app/utils/restHealing.ts`. Max AP = 5 + floor(level/5) per PTU Core (p221).
3. Wired AP restoration into `app/server/api/scenes/[id]/deactivate.post.ts` -- reads scene characters, computes maxAp - drainedAp, updates currentAp for each.
4. Wired AP restoration into `app/server/api/scenes/[id]/activate.post.ts` -- restores AP for previously active scenes before switching.
5. Updated all AP-affecting endpoints: `extended-rest`, `new-day` (individual + global), `heal-injury` (drain_ap method), character PUT.
6. Added `currentAp` to serializers and combatant service.
7. Searched for duplicate code paths: all drainedAp references in server now have matching currentAp handling.

Commits: f94dd60, 8321102, a0fc14d, c735e4a, d25d17e.
