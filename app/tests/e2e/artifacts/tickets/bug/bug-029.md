---
ticket_id: bug-029
priority: P3
status: in-progress
domain: api-validation
source: code-review-079
created_at: 2026-02-20
created_by: senior-reviewer
---

## Summary

Character PUT endpoint accepts `boundAp`, `drainedAp`, and `currentAp` fields without input validation. Negative values, non-integers, or values exceeding `maxAp` could corrupt state.

## Expected Behavior

AP fields should be validated: `>= 0`, integer, and ideally `<= maxAp` (derived from character level).

## Actual Behavior

`PUT /api/characters/:id` passes `body.boundAp`, `body.drainedAp`, and `body.currentAp` directly to Prisma without any bounds checking.

## Files to Change

- `app/server/api/characters/[id].put.ts` -- add `Math.max(0, Math.floor(...))` clamping for all AP fields at minimum

## Notes

This is a low-priority issue since the endpoint is GM-only and unlikely to receive malformed input in normal usage. However, defensive validation prevents hard-to-debug state corruption.

## Fix Log

- **File changed:** `app/server/api/characters/[id].put.ts`
- **What:** Added bounds validation for `drainedAp`, `boundAp`, and `currentAp` fields
- **How:** When any AP field is present in the request body, the endpoint now fetches the character's level (or uses the incoming `body.level` if also being updated), computes `maxAp` via `calculateMaxAp(level)`, and clamps each AP value to `Math.min(maxAp, Math.max(0, Math.floor(value)))`. This ensures all AP values are non-negative integers that do not exceed the level-derived maximum.
- **Additional fix:** Error handler now re-throws errors that already have a `statusCode` (e.g., 404 from character lookup) instead of swallowing them as generic 500s.
- **Duplicate check:** Pokemon models do not have AP fields. No other PUT endpoint writes AP fields directly -- all other AP mutations go through dedicated endpoints (`extended-rest`, `new-day`, `heal-injury`, `encounter/end`, `scene/deactivate`) that already compute AP correctly via `calculateMaxAp`/`calculateSceneEndAp`.
