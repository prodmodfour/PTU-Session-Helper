---
ticket_id: bug-025
priority: P2
severity: MEDIUM
status: resolved
domain: character-lifecycle
matrix_source:
  rule_id: character-lifecycle-R008
  audit_file: matrix/character-lifecycle-audit.md
  discovered_by: code-review-056
created_at: 2026-02-19
created_by: orchestrator
---

## Summary

`players.get.ts` returns `char.hp` (raw HP stat value, e.g., 10) as `maxHp` instead of `char.maxHp` (computed trainer HP formula result, e.g., 42). Player view displays trainers with wildly incorrect max HP.

## Expected Behavior

The `GET /api/characters/players` endpoint should return `char.maxHp` (the computed value from `level * 2 + hpStat * 3 + 10`) in the `maxHp` response field.

## Actual Behavior

Line 36 in `app/server/api/characters/players.get.ts`:
```typescript
maxHp: char.hp, // Use hp stat as max HP (PTU convention)
```

Returns the raw HP **stat** value instead of the computed max HP. The comment is misleading — `char.hp` is NOT the PTU max HP, it's the base HP stat.

## Affected Files

- `app/server/api/characters/players.get.ts:36` — one-line fix: `char.hp` → `char.maxHp`

## Fix Direction

Change `char.hp` to `char.maxHp` on line 36. Remove or correct the misleading comment.

## PTU Reference

- Trainer HP formula: `(Level x 2) + (HP Stat x 3) + 10` — Core Chapter 3

## Resolution Log

- **Resolved:** 2026-02-19
- **Commit:** aa4861c — `fix: return computed maxHp instead of raw hp stat in players endpoint`
- **Change:** `app/server/api/characters/players.get.ts:36` — changed `char.hp` to `char.maxHp`, removed misleading "PTU convention" comment
- **Duplicate code path check:** Searched all server endpoints for `maxHp.*char.hp` patterns. The shared serializers (`serializeCharacter`, `serializeCharacterSummary` in `server/utils/serializers.ts`) already correctly use `character.maxHp`. The `players.get.ts` endpoint was the only code path with this bug — it uses inline serialization instead of the shared serializer. Note: `app/tests/unit/api/characters.test.ts:84` contains `maxHp: char.hp` in a test simulating old GET endpoint logic, but that test exercises mock data only and is a separate stale-test concern.
