---
ticket_id: bug-016
priority: P2
severity: MEDIUM
status: in-progress
domain: encounter-tables
matrix_source:
  rule_id: encounter-tables-R022
  audit_file: matrix/encounter-tables-audit.md
created_at: 2026-02-19
created_by: orchestrator
---

## Summary

Pokemon generation hard-caps spawn count at 10, making the "Abundant" density tier (12-16 Pokemon) impossible to achieve. The cap contradicts the app's own density tier constants.

## Expected Behavior

Abundant density tier should spawn 12-16 Pokemon per the app's defined constants. The generation cap should respect the configured density ranges.

## Actual Behavior

A hard-coded `Math.min(count, 10)` (or similar) caps all encounter generation at 10 Pokemon regardless of the density tier. Abundant encounters are clamped to 10, making them identical to "Common" or "Uncommon" tiers.

## Affected Files

- `app/server/api/encounter-tables/` — generation endpoint
- `app/constants/` — density tier definitions

## PTU Reference

- Core Chapter 11 — Encounter Density Tiers

## Fix Log

**Date:** 2026-02-20
**Commit:** `4ba0b8b` — fix: remove hard-coded spawn cap of 10 blocking Abundant density tier

### Root Cause

Four locations hard-coded the number `10` as the maximum spawn count, preventing the Abundant density tier (12-16) from ever being reached:

1. **`app/server/api/encounter-tables/[id]/generate.post.ts` line 105** — manual override path: `Math.min(Math.max(countOverride, 1), 10)`
2. **`app/server/api/encounter-tables/[id]/generate.post.ts` line 113** — density-based path: `Math.min(10, Math.round(densityRange.max * densityMultiplier))`
3. **`app/components/habitat/GenerateEncounterModal.vue` line 46** — HTML input `max="10"` attribute on the override count input
4. **`app/components/habitat/GenerateEncounterModal.vue` line 354** — client-side display: `Math.min(10, ...)`
5. **`app/components/encounter-table/ModificationCard.vue` line 190** — modification card display: `Math.min(10, ...)`

### Fix

- Added `MAX_SPAWN_COUNT` constant to `app/types/habitat.ts`, derived dynamically from `DENSITY_RANGES` via `Math.max(...Object.values(DENSITY_RANGES).map(r => r.max))`. Currently evaluates to `16` (from `abundant.max`).
- Replaced all 5 hard-coded `10` caps with `MAX_SPAWN_COUNT`.
- If density tiers are changed in the future, the cap automatically adjusts.

### Files Changed

- `app/types/habitat.ts` — added `MAX_SPAWN_COUNT` export
- `app/server/api/encounter-tables/[id]/generate.post.ts` — replaced 2 hard-coded caps
- `app/components/habitat/GenerateEncounterModal.vue` — replaced 2 hard-coded caps (input max + display)
- `app/components/encounter-table/ModificationCard.vue` — replaced 1 hard-coded cap (display)
