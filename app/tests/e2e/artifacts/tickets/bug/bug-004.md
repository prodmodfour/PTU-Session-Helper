---
ticket_id: bug-004
type: bug
priority: P1
severity: HIGH
status: in-progress
source_ecosystem: test
target_ecosystem: dev
created_by: feature-designer
created_at: 2026-02-19T23:50:00Z
domain: pokemon-lifecycle
affected_files:
  - app/server/api/capture/attempt.post.ts
scenario_ids:
  - pokemon-lifecycle-workflow-capture-001
---

## Summary

The capture attempt endpoint hardcodes `maxEvolutionStage = Math.max(3, evolutionStage)` instead of reading `speciesData.maxEvolutionStage` from the database. This produces incorrect capture rates for all Pokemon with fewer than 3 evolution stages (single-stage and two-stage Pokemon).

The rate endpoint (`rate.post.ts`) correctly uses `speciesData.maxEvolutionStage`, so the rate preview and the actual attempt use different values.

## PTU Rule Reference

PTU 1.05 capture rate formula uses `evolutionsRemaining = maxEvolutionStage - evolutionStage`:
- 2+ evolutions remaining: +10 bonus (easier to capture)
- 1 evolution remaining: +0
- 0 evolutions remaining: -10 penalty (harder to capture)

## Evidence

**Buggy code** (`attempt.post.ts:53`):
```typescript
const maxEvolutionStage = Math.max(3, evolutionStage)
```

**Correct code** (`rate.post.ts:57-58`):
```typescript
evolutionStage = speciesData.evolutionStage
maxEvolutionStage = speciesData.maxEvolutionStage
```

### Impact by species type

| Species Type | Actual maxEvoStage | Bug gives | evolutionsRemaining (bug) | Correct | Capture rate delta |
|---|---|---|---|---|---|
| 1-stage (Tauros at stage 1) | 1 | 3 | 2 → +10 | 0 → -10 | **+20 too easy** |
| 2-stage (Pikachu at stage 1) | 2 | 3 | 2 → +10 | 1 → +0 | **+10 too easy** |
| 2-stage (Raichu at stage 2) | 2 | 3 | 1 → +0 | 0 → -10 | **+10 too easy** |
| 3-stage (any) | 3 | 3 | correct | correct | 0 (unaffected) |

## Fix

Replace line 53 of `attempt.post.ts`:
```typescript
// Before (buggy):
const maxEvolutionStage = Math.max(3, evolutionStage)

// After (correct):
const maxEvolutionStage = speciesData?.maxEvolutionStage || evolutionStage
```

This matches the pattern used by `rate.post.ts` and falls back to `evolutionStage` (0 evolutions remaining) when no species data exists.

## Fix Log

- **File:** `app/server/api/capture/attempt.post.ts:53`
- **Change:** Replaced `Math.max(3, evolutionStage)` with `speciesData?.maxEvolutionStage || evolutionStage`
- Now matches the pattern used by `rate.post.ts` — reads `maxEvolutionStage` from the species DB record
