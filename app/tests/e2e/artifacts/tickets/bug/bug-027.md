---
ticket_id: bug-027
priority: P2
severity: MEDIUM
status: in-progress
domain: encounter-tables
matrix_source:
  rule_id: encounter-tables-R022
  audit_file: matrix/encounter-tables-audit.md
created_at: 2026-02-20
created_by: senior-reviewer
discovered_in: code-review-062
---

## Summary

When a density multiplier causes `scaledMin` to exceed `scaledMax` (which is capped at `MAX_SPAWN_COUNT`), the random range formula produces spawn counts that exceed the intended cap. This affects both the server generation endpoint and the client-side display functions.

## Expected Behavior

Spawn count should always be between 1 and `MAX_SPAWN_COUNT` (currently 16). When the multiplier pushes the scaled minimum above the cap, `scaledMin` should be clamped to `scaledMax` so the range is valid.

## Actual Behavior

With abundant tier (min: 12, max: 16) and a 2.0x multiplier:
- `scaledMin = Math.max(1, Math.round(12 * 2.0))` = 24
- `scaledMax = Math.min(16, Math.round(16 * 2.0))` = 16
- The formula `Math.floor(Math.random() * (16 - 24 + 1)) + 24` produces values 17-24, exceeding the cap.

This also affects display: `getSpawnRange()` in `GenerateEncounterModal.vue` and `getEffectiveSpawnRange()` in `ModificationCard.vue` would show an inverted range like "24-16".

## Affected Files

- `app/server/api/encounter-tables/[id]/generate.post.ts` — line 112
- `app/components/habitat/GenerateEncounterModal.vue` — `getSpawnRange()` function
- `app/components/encounter-table/ModificationCard.vue` — `getEffectiveSpawnRange()` function

## Suggested Fix

Clamp `scaledMin` to not exceed `scaledMax` in all three locations:

```typescript
const rawMin = Math.max(1, Math.round(densityRange.min * densityMultiplier))
const scaledMax = Math.min(MAX_SPAWN_COUNT, Math.round(densityRange.max * densityMultiplier))
const scaledMin = Math.min(rawMin, scaledMax)
```

## Fix Log

**Commit:** `dc65a10` — `fix: clamp scaledMin to not exceed scaledMax in spawn range calculations`

**Changes (3 files):**

1. **`app/server/api/encounter-tables/[id]/generate.post.ts`** (line 112-114): Renamed `scaledMin` to `rawMin`, then added `const scaledMin = Math.min(rawMin, scaledMax)` to clamp the minimum so it never exceeds the capped maximum. This prevents the random range formula from producing spawn counts above `MAX_SPAWN_COUNT`.

2. **`app/components/habitat/GenerateEncounterModal.vue`** (`getSpawnRange()`, line 353-355): Same pattern -- `rawMin` computed first, then `scaledMin = Math.min(rawMin, scaledMax)`. Prevents the display from showing an inverted range like "24-16".

3. **`app/components/encounter-table/ModificationCard.vue`** (`getEffectiveSpawnRange()`, line 189-191): Same pattern applied to the modification card's spawn range display.

**Duplicate code path check:** Searched for all uses of `DENSITY_RANGES`, `scaledMin`, `scaledMax`, and `densityMultiplier` across the codebase. Three additional files use `DENSITY_RANGES` (`useTableEditor.ts`, `TableCard.vue`, `EncounterTableCard.vue`) but only display base ranges without any multiplier -- they are not affected. The three fixed files are the only code paths that apply a density multiplier to spawn range calculations.

## Notes

- Pre-existing bug discovered during code-review-062 (review of bug-016 fix)
- Existed before bug-016 with the old hard-coded cap of 10
- UI density multiplier presets only go up to 2.0x, but the server accepts up to 5.0x
- Triggerable via abundant+2.0x (UI) or dense+2.0x, moderate+5.0x (API)
