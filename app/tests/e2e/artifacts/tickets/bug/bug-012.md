---
ticket_id: bug-012
priority: P1
severity: HIGH
status: resolved
domain: vtt-grid
matrix_source:
  rule_ids:
    - vtt-grid-R004
    - vtt-grid-R014
    - scenes-R017
  audit_files:
    - matrix/vtt-grid-audit.md
    - matrix/scenes-audit.md
created_at: 2026-02-19
created_by: orchestrator
resolved_at: 2026-02-19
---

## Summary

Click-to-move uses geometric (Euclidean) distance and ignores terrain costs entirely. The Dijkstra-based range display correctly shows terrain-aware reachable cells, but actual movement execution bypasses terrain validation. Moving through Slow terrain costs 1 cell instead of 2, and Blocking terrain may not be enforced.

## Expected Behavior (PTU Rules)

Movement through terrain should respect terrain costs: Slow terrain costs 2 movement per cell, Blocking terrain is impassable (unless flight/burrow), Rough terrain imposes -2 accuracy. The movement validation should use the same terrain-aware pathfinding as the range display.

## Actual Behavior

Three separate audit findings confirm the same root cause:
- `vtt-grid-R004`: Click-to-move uses geometric distance ignoring terrain costs
- `vtt-grid-R014`: Slow terrain cost correctly defined but not applied in movement validation
- `scenes-R017`: Difficult terrain cost defined but useGridMovement ignores it

The range overlay (Dijkstra) shows correct terrain-aware movement ranges, but clicking to move a token uses a simple distance check that ignores all terrain modifiers.

## Affected Files

- `app/composables/useGridMovement.ts` — movement validation logic
- `app/composables/useGridInteraction.ts` — click-to-move handler
- `app/composables/useGridRendering.ts` — movement preview rendering
- `app/components/vtt/GridCanvas.vue` — wiring composables together

## PTU Reference

- Core Chapter 8 — Terrain Types, Movement Rules

## Resolution Log

### Commit: 49a7fb2

**Root Cause:** `useGridMovement.isValidMove()` used a pure geometric `calculateMoveDistance()` that computes PTU diagonal cost (alternating 1m/2m) without considering terrain. This same geometric function was passed to `useGridInteraction` for both click-to-move validation and movement preview, creating a disconnect where the range overlay (Dijkstra-based, terrain-aware) showed different reachable cells than the actual movement allowed.

**Fix:** Made `isValidMove()` in `useGridMovement` terrain-aware by delegating to `useRangeParser.calculatePathCost()` (A* pathfinding with PTU diagonal rules and terrain costs) when terrain exists on the grid. When no terrain is present, it falls back to the fast geometric check for performance.

**Changes:**

1. **`useGridMovement.ts`**: Added `calculateTerrainAwarePathCost()` and `getTerrainCostGetter()` helpers. Rewrote `isValidMove()` to use A* pathfinding when terrain is present. The Dijkstra range display and the click-to-move validation now use the same terrain cost data path.

2. **`useGridInteraction.ts`**: Added `isValidMove` to the options interface. Updated `handleMouseDown` (click-to-move) and `handleMouseMove` (preview) to use `isValidMove` instead of manually checking `calculateMoveDistance` + `getBlockedCells`. This eliminates the duplicated validation logic that was the actual source of the bug.

3. **`useGridRendering.ts`**: Added `isValidMove` to the rendering options. Updated `drawMovementPreview()` to show terrain-aware path cost in the distance label instead of geometric distance.

4. **`GridCanvas.vue`**: Wired `movement.isValidMove` through to both the interaction and rendering composables.

**Behavior after fix:**
- Slow/difficult terrain costs 2 movement per cell (consistent with range overlay)
- Blocking terrain prevents movement through it (consistent with range overlay)
- Water terrain blocks non-swimming combatants
- Movement preview arrow shows actual path cost, not geometric distance
- No terrain on grid = fast geometric check (no performance regression)
