---
ticket_id: bug-006
priority: P0
severity: CRITICAL
status: resolved
domain: healing
matrix_source:
  rule_id: healing-R003
  audit_file: matrix/healing-audit.md
created_at: 2026-02-19
created_by: orchestrator
---

## Summary

Injury-reduced max HP is never computed. All healing restores entities to their full raw `maxHp` instead of the PTU injury-reduced value `maxHp * (10 - injuries) / 10`.

## Expected Behavior (PTU Rules)

Per PTU Core Chapter 9: each injury reduces a character's effective maximum HP by 10%. A Pokemon with 50 maxHp and 3 injuries should have an effective max of `50 * (10-3)/10 = 35`. All healing (rest, Pokemon Center, items) should cap at this reduced maximum.

## Actual Behavior

The app heals to full raw `maxHp` regardless of injury count. A Pokemon with 3 injuries and 50 maxHp heals to 50, not 35. Injuries are tracked and displayed but have no mechanical effect on HP ceiling.

## Impact

Every heal in the app is wrong when injuries > 0. Players and Pokemon recover more HP than they should, undermining the injury system entirely. This makes injuries cosmetic rather than mechanically significant.

## Affected Files

- `app/composables/useRestHealing.ts` — rest healing calculations
- `app/server/api/healing/` — all healing endpoints
- Any client code that caps HP at `maxHp`

## PTU Reference

- Core Chapter 9 — Injuries and Healing

## Resolution Log

- **Commit:** `85af350`
- **Date:** 2026-02-19
- **Changes:**
  1. Added `getEffectiveMaxHp(maxHp, injuries)` utility to `app/utils/restHealing.ts` — computes `floor(maxHp * (10 - injuries) / 10)`
  2. Updated `calculateRestHealing()` to use injury-reduced effective max for both the "already at full HP" check and the heal amount/cap calculation
  3. Updated `getRestHealingInfo()` to use injury-reduced max for the `hpPerRest` display value
  4. Updated Pokemon Center endpoints (`app/server/api/pokemon/[id]/pokemon-center.post.ts` and `app/server/api/characters/[id]/pokemon-center.post.ts`) to heal to effective max instead of raw maxHp, computing effective max after injury healing
  5. Updated `applyHealingToEntity()` in `app/server/services/combatant.service.ts` to cap in-combat healing at injury-reduced max HP
- **Files modified:** `app/utils/restHealing.ts`, `app/server/api/pokemon/[id]/pokemon-center.post.ts`, `app/server/api/characters/[id]/pokemon-center.post.ts`, `app/server/services/combatant.service.ts`
- **Note:** Damage calculation and HP marker thresholds correctly continue to use raw maxHp per PTU rules (07-combat.md:1872-1876). Only healing caps are affected.
- **Tests:** All 476 unit tests pass.

### Review Feedback (code-review-054 / rules-review-048)

- **Commit:** `8cb6057` — Deduplicated `getEffectiveMaxHp` in `InitiativeTracker.vue` and `CombatantDetailsPanel.vue`: replaced inline formulas (which lacked injury clamping to 10) with imports from `~/utils/restHealing`.
- **Commit:** `b728351` — Reordered `applyHealingToEntity` in `combatant.service.ts` to heal injuries before HP, so the effective max cap reflects post-injury-heal count (matches Pokemon Center endpoint ordering).
- **Commit:** `bf44494` — Changed `calculateRestHealing()` and `getRestHealingInfo()` to use real `maxHp` (not `effectiveMax`) for the 1/16th healing amount per PTU p.250 ("Effects that go off Max Hit Points use the real maximum"). The HP cap still uses `effectiveMax`.
- **Commit:** `2b9c66d` — Added 14 unit tests for `getEffectiveMaxHp` and `calculateRestHealing` in `app/tests/unit/utils/restHealing.test.ts`.
- **Tests:** All 490 unit tests pass (19 files).
