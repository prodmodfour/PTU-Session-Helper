---
bug_id: bug-002
severity: HIGH
category: APP_BUG
scenario_id: capture-mechanic-worked-examples-001
affected_files:
  - app/prisma/seed.ts
  - app/server/api/capture/rate.post.ts
---

## What Happened

The SpeciesData seeder stores `evolutionStage=1` for ALL species regardless of their actual position in the evolution chain. Combined with a `Math.max(3, evolutionStage)` hardcode in the capture rate endpoint, every Pokemon gets `evolutionsRemaining=2` and an evolution modifier of `+10` — even fully-evolved Pokemon that should get `-10`.

This caused 2 assertion failures in the PTU worked examples:
- **Pikachu** (stage 2/3): expected evolutionModifier=0, got +10 (captureRate 80 instead of 70)
- **Hydreigon** (stage 3/3): expected evolutionModifier=-10, got +10 (captureRate 5 instead of -15)

## Expected vs Actual

**Assertion 1 — Pikachu (Stage 2 of Pichu/Pikachu/Raichu):**
- **Expected:** captureRate=70, evolutionModifier=0 (evolutionStage=2, maxStage=3, remaining=1)
- **Actual:** captureRate=80, evolutionModifier=10 (evolutionStage=1, maxStage=3, remaining=2)

**Assertion 3 — Hydreigon (Stage 3 of Deino/Zweilous/Hydreigon):**
- **Expected:** captureRate=-15, evolutionModifier=-10 (evolutionStage=3, maxStage=3, remaining=0)
- **Actual:** captureRate=5, evolutionModifier=10 (evolutionStage=1, maxStage=3, remaining=2)

## Root Cause Analysis

Two cascading bugs:

### 1. Seeder regex only captures stage 1 (`seed.ts:300-303`)

```typescript
const evoMatch = pageText.match(/Evolution:\s*\n?\s*(\d)\s*-\s*\w+/i)
```

This regex matches the **first line** after "Evolution:", which is always stage 1 (the base form). For Pikachu's pokedex entry:
```
Evolution:
1 - Pichu
2 - Pikachu Minimum 10
3 - Raichu Thunderstone Minimum 20
```
The regex captures `1` from `1 - Pichu` and stops. It does not determine which stage in the chain corresponds to the **current** species being parsed. So every species gets `evolutionStage=1`.

### 2. API hardcodes maxEvolutionStage=3 (`rate.post.ts:60`)

```typescript
maxEvolutionStage = Math.max(3, evolutionStage)
```

Since `evolutionStage` is always `1`, this always produces `maxEvolutionStage=3`, giving `evolutionsRemaining = 3 - 1 = 2`, which maps to `+10` for every Pokemon.

### Impact

| Pokemon Type | Correct Modifier | Actual Modifier | Error |
|---|---|---|---|
| Stage 1 of 3 (e.g. Caterpie) | +10 | +10 | None |
| Stage 2 of 3 (e.g. Pikachu) | 0 | +10 | +10 |
| Stage 3 of 3 (e.g. Hydreigon) | -10 | +10 | +20 |
| Stage 1 of 2 (e.g. Growlithe) | +10 | +10 | None* |
| Stage 2 of 2 (e.g. Arcanine) | -10 | +10 | +20 |
| Stage 1 of 1 (e.g. Absol) | -10 | +10 | +20 |

*2-stage lines happen to produce the right answer for stage 1 only because `Math.max(3,1)=3` and `3-1=2` gives +10. This is coincidentally correct for a different reason — 2-stage lines should use maxStage=2, remaining=1, modifier=0. The bug exists but is masked.

## PTU Rule Reference

core/05-pokemon.md p215: "If the Pokemon has two or more evolutionary stages remaining, add 10 to the Pokemon's Capture Rate. If the Pokemon has one evolutionary stage remaining, the Capture Rate is unmodified. If the Pokemon cannot evolve any further (is at its final stage), subtract 10."

## Suggested Fix

**Fix 1 (seed.ts):** Parse the full evolution block and match the current species name to determine its stage number. The regex should find all `N - SpeciesName` lines, then match the current `pokemonName` against them.

**Fix 2 (rate.post.ts):** Replace `Math.max(3, evolutionStage)` with actual `maxEvolutionStage` from SpeciesData. This requires either:
- Adding a `maxEvolutionStage` column to the SpeciesData schema, or
- Counting the total evolution lines during seeding and storing the count

**Fix 3 (schema.prisma):** Add `maxEvolutionStage Int @default(1)` to the SpeciesData model so both values are available.

## Fix Log
- [x] Fixed in commit: ec11197
- [x] Files changed:
  - `app/prisma/schema.prisma` — added `maxEvolutionStage` column to SpeciesData
  - `app/prisma/seed.ts` — parse full evolution block to determine correct `evolutionStage` and `maxEvolutionStage` per species; switched `deleteMany`+`create` to `upsert` to avoid FK constraint violations
  - `app/server/api/capture/rate.post.ts` — replaced `Math.max(3, evolutionStage)` hardcode with `speciesData.maxEvolutionStage` in both code paths
- [ ] Re-run scenario: capture-mechanic-worked-examples-001
