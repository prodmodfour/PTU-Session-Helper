---
type: FEATURE_GAP
severity: HIGH
filed_by: playtester
date: 2026-02-19
domain: healing
blocked_scenarios:
  - healing-injury-rest-block-001
  - healing-pokemon-center-time-001
  - healing-daily-injury-cap-001
  - healing-ap-drain-injury-001
  - healing-workflow-injury-healing-cycle-001
  - healing-workflow-pokemon-center-full-heal-001
  - healing-natural-injury-timer-001
  - healing-daily-rest-cap-001
  - healing-workflow-global-new-day-reset-001
  - healing-workflow-overnight-extended-rest-001
status: open
---

# FEATURE_GAP: PUT endpoints missing healing-related fields

## Summary

The `PUT /api/pokemon/:id` and `PUT /api/characters/:id` endpoints do not support setting healing-related fields. These fields are required for test setup in 10 out of 16 healing domain scenarios.

## Missing Fields

### Pokemon PUT (`server/api/pokemon/[id].put.ts`)
- `injuries` — current injury count
- `restMinutesToday` — daily rest minutes consumed
- `injuriesHealedToday` — daily injury heal counter
- `lastInjuryTime` — timestamp of last injury (for 24h natural healing timer)
- `lastRestReset` — timestamp of last daily counter reset
- `drainedAp` — (Pokemon don't use this, but listing for completeness)

### Character PUT (`server/api/characters/[id].put.ts`)
- `injuries` — current injury count
- `restMinutesToday` — daily rest minutes consumed
- `injuriesHealedToday` — daily injury heal counter
- `lastInjuryTime` — timestamp of last injury
- `lastRestReset` — timestamp of last daily counter reset
- `drainedAp` — drained action points
- `maxHp` — max HP (currently not updatable; also response returns `character.hp` as maxHp which appears to be a bug)

## Impact

These fields exist in the database (Prisma schema) and are read/written by the healing endpoints (rest, extended-rest, pokemon-center, heal-injury, new-day). However, the PUT endpoints whitelist specific fields and silently drop any fields not in the whitelist.

Without the ability to set these fields, test setup cannot put entities into the initial states required by scenarios. For example:
- **healing-injury-rest-block-001** needs `injuries: 5` to test the "5+ injuries blocks rest" rule
- **healing-daily-rest-cap-001** needs `restMinutesToday: 450` to test the 480-minute daily cap
- **healing-natural-injury-timer-001** needs `lastInjuryTime` set to 25 hours ago

## Recommended Fix

Add the missing fields to the whitelist in both PUT handlers:

```typescript
// In server/api/pokemon/[id].put.ts
if (body.injuries !== undefined) updateData.injuries = body.injuries
if (body.restMinutesToday !== undefined) updateData.restMinutesToday = body.restMinutesToday
if (body.injuriesHealedToday !== undefined) updateData.injuriesHealedToday = body.injuriesHealedToday
if (body.lastInjuryTime !== undefined) updateData.lastInjuryTime = body.lastInjuryTime ? new Date(body.lastInjuryTime) : null
if (body.lastRestReset !== undefined) updateData.lastRestReset = body.lastRestReset ? new Date(body.lastRestReset) : null

// In server/api/characters/[id].put.ts — same fields plus:
if (body.injuries !== undefined) updateData.injuries = body.injuries
if (body.drainedAp !== undefined) updateData.drainedAp = body.drainedAp
if (body.maxHp !== undefined) updateData.maxHp = body.maxHp
if (body.restMinutesToday !== undefined) updateData.restMinutesToday = body.restMinutesToday
if (body.injuriesHealedToday !== undefined) updateData.injuriesHealedToday = body.injuriesHealedToday
if (body.lastInjuryTime !== undefined) updateData.lastInjuryTime = body.lastInjuryTime ? new Date(body.lastInjuryTime) : null
if (body.lastRestReset !== undefined) updateData.lastRestReset = body.lastRestReset ? new Date(body.lastRestReset) : null
```

## Secondary Bug: Character PUT maxHp response

In `server/api/characters/[id].put.ts` line 62, the response returns:
```typescript
maxHp: character.hp,  // Returns base HP stat, not actual maxHp column
```
This should be:
```typescript
maxHp: character.maxHp,
```
