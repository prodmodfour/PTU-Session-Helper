---
bug_id: bug-001
severity: HIGH
category: APP_BUG
scenario_id: combat-workflow-faint-replacement-001
affected_files:
  - app/server/services/combatant.service.ts
---

## What Happened

When Caterpie fainted (HP reached 0), the "Fainted" status was correctly added to `statusConditions`, but the pre-existing "Burned" status was not removed. The app returned `["Burned", "Fainted"]` instead of `["Fainted"]`.

## Expected vs Actual

- **Expected:** `statusConditions = ["Fainted"]` — all persistent and volatile statuses cleared on faint, only "Fainted" remains
- **Actual:** `statusConditions = ["Burned", "Fainted"]` — "Burned" persisted through faint

## Root Cause Analysis

In `app/server/services/combatant.service.ts`, the `applyDamageToEntity()` function (around line 70-85) only **appends** "Fainted" to the existing `statusConditions` array when HP reaches 0. It does not clear any pre-existing statuses:

```typescript
if (damageResult.fainted && !entity.statusConditions?.includes('Fainted')) {
  entity.statusConditions = entity.statusConditions || []
  entity.statusConditions.push('Fainted')
}
```

The fix needs to clear all persistent and volatile statuses before adding "Fainted".

## PTU Rule Reference

core/07-combat.md p248: "automatically cured of all Persistent and Volatile Status Conditions" when a Pokemon faints (HP reaches 0).

Persistent statuses that should be cleared: Burned, Frozen, Paralyzed, Poisoned, Badly Poisoned, Asleep.
Volatile statuses that should be cleared: Confused, Flinched, Infatuated, Cursed, Disabled, Encored, Taunted, Tormented, Stuck, Slowed, Trapped, Enraged, Suppressed, Tripped, Vulnerable.

## Suggested Fix

In `applyDamageToEntity()`, when `damageResult.fainted` is true, replace the current status array with only `["Fainted"]` instead of appending:

```typescript
if (damageResult.fainted && !entity.statusConditions?.includes('Fainted')) {
  entity.statusConditions = ['Fainted']
}
```

This clears all prior statuses and sets only "Fainted", matching the PTU rule.

## Fix Log
- [x] Fixed in commit: 72df77b
- [x] Files changed: app/server/services/combatant.service.ts
- [x] Review fix 1 — commit: 84b9f6c — simplified faint guard (removed redundant includes check)
- [x] Review fix 2 — commit: b9dfed7 — move.post.ts now uses full PTU damage pipeline (calculateDamage + applyDamageToEntity + syncDamageToDatabase)
- [ ] Re-run scenario: combat-workflow-faint-replacement-001
