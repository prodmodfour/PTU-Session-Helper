generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = "file:./ptu.db"
}

// Human characters (players and NPCs)
model HumanCharacter {
  id            String   @id @default(uuid())
  name          String
  characterType String   @default("npc") // 'player', 'npc', or 'trainer'

  // Player info (for player characters)
  playedBy      String?  // Player's real name
  age           Int?
  gender        String?  // 'Male', 'Female', 'Other'
  height        Int?     // in cm
  weight        Int?     // in kg

  // Stats
  level         Int      @default(1)
  hp            Int      @default(10)
  attack        Int      @default(5)
  defense       Int      @default(5)
  specialAttack Int      @default(5)
  specialDefense Int     @default(5)
  speed         Int      @default(5)
  currentHp     Int      @default(10)
  maxHp         Int      @default(10) // Derived max HP (different from hp stat)

  // Classes, skills, features, edges stored as JSON
  trainerClasses String  @default("[]") // JSON array of class names
  skills         String  @default("{}") // JSON object { skillName: rank }
  features       String  @default("[]") // JSON array of feature names
  edges          String  @default("[]") // JSON array of edge names

  // Inventory
  inventory     String   @default("[]") // JSON array
  money         Int      @default(0)

  // Status
  statusConditions String @default("[]") // JSON array
  stageModifiers   String @default("{}") // JSON object
  injuries         Int    @default(0)
  temporaryHp      Int    @default(0)

  // Rest & Healing Tracking
  lastInjuryTime     DateTime? // When the last injury was received (for 24h natural healing)
  restMinutesToday   Int       @default(0) // Rest minutes used today (max 480 for HP regen)
  injuriesHealedToday Int      @default(0) // Injuries healed today (max 3 from Pokemon Center)
  lastRestReset      DateTime? // When daily rest counters were last reset
  drainedAp          Int       @default(0) // Drained AP (restored by extended rest)

  // Display
  avatarUrl     String?

  // Background info
  background    String?  // Character background/history
  personality   String?
  goals         String?

  // Library
  isInLibrary   Boolean  @default(true)
  notes         String?

  // Relations
  pokemon       Pokemon[]

  // Timestamps
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}

// Pokemon
model Pokemon {
  id            String   @id @default(uuid())
  species       String
  nickname      String?
  level         Int      @default(1)
  experience    Int      @default(0)

  // Nature stored as JSON { name, raisedStat, loweredStat }
  nature        String   @default("{}") // JSON object

  // Types
  type1         String
  type2         String?

  // Base stats (species base + added points)
  baseHp        Int
  baseAttack    Int
  baseDefense   Int
  baseSpAtk     Int
  baseSpDef     Int
  baseSpeed     Int

  // Current stats (calculated with nature/stage mods)
  currentHp     Int
  maxHp         Int
  currentAttack Int
  currentDefense Int
  currentSpAtk  Int
  currentSpDef  Int
  currentSpeed  Int

  // Stage modifiers stored as JSON
  stageModifiers String  @default("{}") // JSON object

  // Abilities and moves stored as JSON
  abilities     String   @default("[]") // JSON array
  moves         String   @default("[]") // JSON array with full move data

  // Item
  heldItem      String?

  // Capabilities (PTU movement/abilities) stored as JSON
  // { overland, swim, sky, burrow, levitate, jump: {high, long}, power, weightClass, size, naturewalk, otherCapabilities }
  capabilities  String   @default("{}") // JSON object

  // Skills (Pokemon can have skills too)
  skills        String   @default("{}") // JSON object { skillName: diceFormula }

  // Status
  statusConditions String @default("[]") // JSON array
  injuries         Int    @default(0)
  temporaryHp      Int    @default(0)

  // Rest & Healing Tracking
  lastInjuryTime     DateTime? // When the last injury was received (for 24h natural healing)
  restMinutesToday   Int       @default(0) // Rest minutes used today (max 480 for HP regen)
  injuriesHealedToday Int      @default(0) // Injuries healed today (max 3 from Pokemon Center)
  lastRestReset      DateTime? // When daily rest counters were last reset

  // Tutor points and training
  tutorPoints   Int      @default(0)
  trainingExp   Int      @default(0)

  // Display
  spriteUrl     String?
  shiny         Boolean  @default(false)
  gender        String   @default("Genderless")

  // Egg groups (for breeding)
  eggGroups     String   @default("[]") // JSON array

  // Library & categorization
  isInLibrary   Boolean  @default(true) // Repurposed as archive flag: false = archived
  origin        String   @default("manual") // 'manual', 'wild', 'template', 'import', 'captured'
  notes         String?

  // Ownership
  ownerId       String?
  owner         HumanCharacter? @relation(fields: [ownerId], references: [id])

  // Timestamps
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}

// Encounters
model Encounter {
  id            String   @id @default(uuid())
  name          String
  battleType    String   @default("trainer") // 'trainer' or 'full_contact'
  weather       String?  // sunny, rain, sandstorm, hail, snow, fog, harsh_sunlight, heavy_rain, strong_winds

  // Combatants stored as JSON (includes all combat state + positions)
  combatants    String   @default("[]") // JSON array

  // Turn tracking
  currentRound  Int      @default(1)
  currentTurnIndex Int   @default(0)
  turnOrder     String   @default("[]") // JSON array of combatant IDs

  // State
  isActive      Boolean  @default(true)
  isPaused      Boolean  @default(false)
  isServed      Boolean  @default(false) // Whether this encounter is served to the Group View

  // VTT Grid configuration
  gridEnabled   Boolean  @default(false)
  gridWidth     Int      @default(20)
  gridHeight    Int      @default(15)
  gridCellSize  Int      @default(40) // pixels
  gridBackground String? // URL to background image

  // Fog of War state (JSON: { cells: [key, state][], defaultState: string })
  fogOfWarEnabled Boolean @default(false)
  fogOfWarState   String  @default("{}") // JSON object for fog state persistence

  // Terrain state (JSON: { cells: TerrainCell[] })
  terrainEnabled  Boolean @default(false)
  terrainState    String  @default("{}") // JSON object for terrain persistence

  // History
  moveLog       String   @default("[]") // JSON array

  // XP tracking
  defeatedEnemies String @default("[]") // JSON array

  // Timestamps
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}

// Move reference data
model MoveData {
  id            String   @id @default(uuid())
  name          String   @unique
  type          String
  damageClass   String   // 'Physical', 'Special', 'Status'
  frequency     String
  ac            Int?
  damageBase    Int?
  range         String
  effect        String
  contestType   String?
  contestEffect String?
}

// Ability reference data
model AbilityData {
  id            String   @id @default(uuid())
  name          String   @unique
  effect        String
  trigger       String?
}

// Pokemon species reference data
model SpeciesData {
  id            String   @id @default(uuid())
  name          String   @unique
  type1         String
  type2         String?
  baseHp        Int
  baseAttack    Int
  baseDefense   Int
  baseSpAtk     Int
  baseSpDef     Int
  baseSpeed     Int
  abilities     String   // JSON array of ability names
  eggGroups     String   // JSON array
  evolutionStage Int     @default(1)

  // Movement capabilities (for VTT)
  overland      Int      @default(5)
  swim          Int      @default(0)
  sky           Int      @default(0)
  burrow        Int      @default(0)
  levitate      Int      @default(0)
  teleport      Int      @default(0)

  // Level-up move learnset (JSON array: [{ level: number, move: string }])
  learnset      String   @default("[]")

  // Skills (JSON object: { skillName: diceFormula })
  skills        String   @default("{}")

  // Other capabilities (JSON array: ["Naturewalk (Forest)", "Underdog", etc.])
  capabilities  String   @default("[]")

  // Relation to encounter table entries
  encounterTableEntries EncounterTableEntry[]
}

// ============================================
// ENCOUNTER TABLE SYSTEM (Habitats)
// ============================================

// Encounter Table (a.k.a. Habitat) - weighted list of Pokemon for a location
model EncounterTable {
  id            String   @id @default(uuid())
  name          String
  description   String?
  imageUrl      String?

  // Default level range for generated Pokemon
  levelMin      Int      @default(1)
  levelMax      Int      @default(10)

  // Population density tier (sparse, moderate, dense, abundant)
  density       String   @default("moderate")

  // Entries (Pokemon in this table)
  entries       EncounterTableEntry[]

  // Sub-tables (modifications of this table)
  modifications TableModification[]

  // Timestamps
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}

// Entry in an Encounter Table (Pokemon + weight)
model EncounterTableEntry {
  id            String   @id @default(uuid())

  // Reference to species
  speciesId     String
  species       SpeciesData @relation(fields: [speciesId], references: [id])

  // Weight determines encounter probability (higher = more common)
  weight        Int      @default(10)

  // Optional level override (null = use table's default range)
  levelMin      Int?
  levelMax      Int?

  // Parent table
  tableId       String
  table         EncounterTable @relation(fields: [tableId], references: [id], onDelete: Cascade)

  @@unique([tableId, speciesId])
}

// Table Modification (a.k.a. Sub-habitat) - modifications to a parent table
model TableModification {
  id            String   @id @default(uuid())
  name          String
  description   String?

  // Parent table this modifies
  parentTableId String
  parentTable   EncounterTable @relation(fields: [parentTableId], references: [id], onDelete: Cascade)

  // Optional level range override
  levelMin      Int?
  levelMax      Int?

  // Density multiplier - scales parent table's density (0.5 = half, 2.0 = double)
  densityMultiplier Float @default(1.0)

  // Modification entries
  entries       ModificationEntry[]

  // Timestamps
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}

// Entry in a Table Modification (override weight, add, or remove)
model ModificationEntry {
  id            String   @id @default(uuid())

  // Species name (not foreign key - allows adding species not in parent)
  speciesName   String

  // Action: override weight, or remove from table
  // If weight is null and remove is true, this species is excluded
  // If weight is set, it overrides parent weight (or adds if not in parent)
  weight        Int?
  remove        Boolean  @default(false)

  // Optional level override
  levelMin      Int?
  levelMax      Int?

  // Parent modification
  modificationId String
  modification  TableModification @relation(fields: [modificationId], references: [id], onDelete: Cascade)

  @@unique([modificationId, speciesName])
}

// ============================================
// ENCOUNTER TEMPLATE LIBRARY
// ============================================

// Saved encounter template for reuse
model EncounterTemplate {
  id            String   @id @default(uuid())
  name          String
  description   String?
  battleType    String   @default("trainer")

  // Stored combatant configurations (JSON)
  combatants    String   @default("[]")

  // Optional grid configuration
  gridWidth     Int?
  gridHeight    Int?
  gridCellSize  Int?

  // Organization
  category      String?
  tags          String   @default("[]") // JSON array

  // Timestamps
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}

// ============================================
// APP SETTINGS
// ============================================

// App-wide settings (single row table)
model AppSettings {
  id            String   @id @default("default")

  // Damage mode: 'set' uses average damage, 'rolled' simulates dice
  damageMode    String   @default("set") // 'set' | 'rolled'

  // VTT defaults
  defaultGridWidth  Int  @default(20)
  defaultGridHeight Int  @default(15)
  defaultCellSize   Int  @default(40) // pixels

  // Timestamps
  updatedAt     DateTime @updatedAt
}

// ============================================
// SCENE SYSTEM (Group View Tabs)
// ============================================

// Scene - narrative view with Pokemon, characters, environment
model Scene {
  id            String   @id @default(cuid())
  name          String
  description   String?

  // Location
  locationName  String?
  locationImage String?  // Background image URL

  // Content (JSON arrays)
  pokemon       String   @default("[]")  // [{ id, speciesId, species, level, nickname, position: {x,y}, groupId? }]
  characters    String   @default("[]")  // [{ id, characterId, name, avatarUrl, position: {x,y}, groupId? }]
  groups        String   @default("[]")  // [{ id, name, position: {x,y}, width, height }]

  // Environment
  weather       String?  // sunny, rain, sandstorm, hail, snow, fog, harsh_sunlight, heavy_rain, strong_winds
  terrains      String   @default("[]")  // ["grassy", "electric", "psychic", "misty"]
  modifiers     String   @default("[]")  // [{ name, description, effect }]

  // Habitat link for wild spawns
  habitatId     String?

  // State
  isActive      Boolean  @default(false)

  // Timestamps
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}

// Group View State - tracks which tab is shown on Group View
model GroupViewState {
  id            String   @id @default("singleton")
  activeTab     String   @default("lobby")  // lobby | scene | encounter | map
  activeSceneId String?
  updatedAt     DateTime @updatedAt
}
